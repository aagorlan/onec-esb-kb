---
title: "Работа с очередями КШД"
date: 2024-01-31
author: "aagorlan"
tags: ["ШД"]
description: "Реализация функций работы с очередями узла КШД"
---

{{< toc >}}

## Общие принципы подключения узла

Внутренние сервисы узла получают и отправляют данные в локальную очередь (Регистр сведений). Для эффективной (параллельной) работы с регистром необходимо реализовать следующие функции:

* Добавление новых данных (нового сообщения) в очередь
* Начало чтения данных из очереди
* Завершение чтения данных из очереди

## Добавление новых данных (нового сообщения) в очередь

**Особенности объекта управления, влияющие на проектные решения по функции**\
Для идентификации сообщения в очереди используется в том числе дата помещения в очереди в миллисекундах, т.к. стандартная функция получения миллисекунд (ТекущаяУниверсальнаяДатаВМиллисекундах) при вызове транзакции возвращает количество миллисекунд на начало транзакции, получение этого значения для записи в регистр должно получаться гарантированно вне транзакции (в фоновом процессе).

**Входящие данные**\
ИдентификаторСервиса, Контур, Пакет, ИдентификаторСообщения

**Исходящие данные**\
Положительный результат или описание ошибки

**Исполнитель**\
Регламентное задание сервиса

**Описание реализуемых задач**\
Функция должна проверить корректность передаваемых параметров, в случае нарушения контроля возвращается ошибка. После прохождения всех проверок запустить фоновый процесс, добавляющий в регистр очереди новую запись.
Проверка данных:

* Идентификатор сервиса должен быть заполнен и (будет добавлено после разработки сервиса "Сервисы ноды") наличие сервиса в общем перечне сервисов КШД
* Контур должен быть заполнен и определен на уровне КШД
* Пакет должен быть заполнен и (будет добавлено после реализации схемы данных) пройти проверку на структуру данных

## Начало чтения данных из очереди

**Особенности объекта управления, влияющие на проектные решения по функции**\
Может быть достаточно много параллельных запросов от разных сервисов на получение очередной порции данных. В рамках одного сервиса может быть реализована многопоточная обработка

**Входящие данные**\
ИдентификаторСервиса

**Исходящие данные**\
Данные очередного пакета из очереди или ответ, что новых сообщений нет

**Исполнитель**\
Регламентное задание сервиса

**Описание реализуемых задач**\
Для обеспечения последовательного чтения данных из очереди для одного сервиса необходимо установить блокировку очереди по сервису. Из очереди считывается самое раннее размещенное в ней сообщение с незаполненной датой чтения, для данного сообщения устанавливается дата чтения и возвращается информация о идентификаторе сообщения, пакете данных которые в нем передавались и контур в котором это сообщение было размещено.

## Завершение чтения данных из очереди

**Особенности объекта управления, влияющие на проектные решения по функции**\
Каждое сообщение в очереди для сервиса имеет уникальный идентификатор.

**Входящие данные**\
ИдентификаторСервиса, ИдентификаторСообщения

**Исходящие данные**\
Положительный результат или описание ошибки

**Исполнитель**\
Регламентное задание сервиса

**Описание реализуемых задач**\
Ищет сообщение по переданным идентификаторам и удаляет его из очереди.
