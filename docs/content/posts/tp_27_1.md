---
title: "Обеспечение работы сервиса с сообщениями"
date: 2024-02-06
author: "aagorlan"
tags: ["ШД"]
description: "Реализация примера сервиса (Демо сервис), в задачу которого входит получение сообщения и его обратное помещение в очередь (при установке соответствующей константы)"
---

{{< toc >}}

## Общие принципы работы сервиса с сообщениями

Для конфигурации определяются фиксированные сервисы, описанные в переопределяемом модуле. 

## Настройка работы сервиса с очередью и статистика работы

**Особенности объекта управления, влияющие на проектные решения по функции**\
Администратор базы данных настраивает самостоятельно какие сервисы сколько потоков будут использовать для чтения сообщений из очереди.

**Входящие данные**\
Идентификатор сервиса

**Исходящие данные**\
Отсутствует

**Исполнитель**\
Администратор базы данных

**Описание реализуемых задач**\
Необходимо реализовать управление перечнем сервисов узла, с выводом текущей статистики по количеству сообщений в очереди, количеству использованных потоков и скорости чтения сообщений из очереди Пользователь может включить/отключить любой из сервисов или настроить для любого сервиса количество потоков обработки информации.

## Чтение сообщений из очереди в несколько потоков

**Особенности объекта управления, влияющие на проектные решения по функции**\
Чтение сообщения из очереди производится в 3 этапа: 1 - получение данных из очереди, 2 - обработка данных сервисом и 3 - подтверждение (удаление) сообщения из очереди. Для сервиса должна поддерживаться многопоточная обработка сообщений.

**Входящие данные**\
Идентификатор сервиса

**Исходящие данные**\
Идентификатор сообщения, Данные, Контур

**Исполнитель**\
Регламентное задание, индивидуальное для каждого сервиса

**Описание реализуемых задач**\
Для каждого сервиса запускается отдельное регламентное задание определяющее максимальное количество потоков, использованное количество потоков и если свободные потоки есть, делает попытку чтения нового сообщения из очереди сервиса и запуска его обработки в фоновом процессе (новом потоке).

## Подтверждение чтения сообщения из очереди

**Особенности объекта управления, влияющие на проектные решения по функции**\
После обработки данных сервис самостоятельно подтверждает завершение приемки сообщения через его идентификатор.

**Входящие данные**\
Идентификатор сообщения, Идентификатор сервиса

**Исходящие данные**\
Отсутствуют

**Исполнитель**\
Фоновый процесс обработки полученного сообщения

**Описание реализуемых задач**\
Для переданных ключевых полей ищет сообщение в очереди и удаляет его.

## Сбор статистики обработки сообщений сервисом

**Особенности объекта управления, влияющие на проектные решения по функции**\
Отсутствуют.

**Входящие данные**\
Идентификатор сообщения, Идентификатор сервиса, этап обработки

**Исходящие данные**\
Отсутствуют

**Исполнитель**\
Фоновый процесс обработки полученного сообщения или Регламентное задание поучения и распределения сообщений по потокам обработки

**Описание реализуемых задач**\
Запись информации о времени событий обработки данных очереди: Добавление, Запрос сообщения, Чтение, Обработка и Удаление.

## Сбор показателей работы сервиса с очередью сообщений

**Особенности объекта управления, влияющие на проектные решения по функции**\
Отсутствуют.

**Входящие данные**\
Идентификатор сервиса

**Исходящие данные**\
Отсутствуют

**Исполнитель**\
Регламентное задание

**Описание реализуемых задач**\
Фиксация для каждого вызова количества сообщений по очередям и количества использованных потоков для каждого сервиса.

## Свертка показателей работы сервиса с очередью сообщений

**Особенности объекта управления, влияющие на проектные решения по функции**\
Отсутствуют.

**Входящие данные**\
Идентификатор сервиса

**Исходящие данные**\
Отсутствуют

**Исполнитель**\
Регламентное задание

**Описание реализуемых задач**\
Все показатели работы, записанные более часа назад, сворачиваются в одно значение для данного часа (максимальное).
