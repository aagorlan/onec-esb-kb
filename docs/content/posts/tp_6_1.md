---
title: "Подключение узла к КШД"
date: 2024-01-18
author: "aagorlan"
tags: ["ШД"]
description: "Реализация функций подключения и контроля состояния узла КШД"
---

{{< toc >}}

## Общие принципы подключения узла

Все настройки хранятся в ветке master репозитория ЕСД. Для подключения используются файлы данных проектов, контуров и узлов. Каждый узел КШД уникален, идентификатором узла базы 1С:Предприятие служит строка подключения. При изменении места положения базы (копировании ее) производится проверка наличия регистрации узла по текущему расположению, если найден, переключение настроек на данную регистрацию. Если настройки для нового расположения отсутствует работа с КШД узла блокируется до ручного переподключения на новом месте. Для обеспечения работы узла с КШД необходимо реализовать следующие функции:

* Проверка подключения узла и контроль расположения узла
* Подключение и изменение подключения узла
* Изменение настроек узла в случае его переноса
* Контроль и обновление репозиториев контуров узла

## Проверка подключения узла и контроль расположения узла

**Особенности объекта управления, влияющие на проектные решения по функции**\
Идентификатором узла 1С:Предприятие является строка подключения базы данных. При изменении места расположения базы данных настройки обновляются автоматически, если ранее для этой строки подключения базы данных было настроено подключение к КШД или работа с КШД блокируется.

**Входящие данные**\
Строка подключения базы данных

**Исходящие данные**\
Структура с набором параметров которые отображают результат проверки и в случае успешного подключения данные текущего узла

**Исполнитель**\
Служба поддержки узла

**Описание реализуемых задач**\
Создать отдельную обработку для подсистемы "Администрирование", при открытии которой производится диагностика подключения узла к КШД. Диагностика производится в следующем порядке: контроль наличия установленного Git на сервере, проверка наличия настройки подключения к Git с наименованием master, проверка наличия флага инициализации у настройки, обновление данных ветки master в локальном репозитории, чтение конфигурации узла по текущему расположению базы данных, если расположение не соответствует сохраненному ранее, изменение настройки работы с Git на настройки узла считанные из КШД.

## Подключение и изменение подключения узла

**Особенности объекта управления, влияющие на проектные решения по функции**\
После успешного подключения или переподключения данные узла в master обновляются автоматически. В отдельной константе фиксируется строка подключения базы данных для контроля ее перемещения.

**Входящие данные**\
Строка подключения базы данных

**Исходящие данные**\
Отсутствуют

**Исполнитель**\
Служба поддержки узла

**Описание реализуемых задач**\
Форма с полями для подключения узла. При изменении данных подключения автоматически проверяется корректность настроек и возможность подключения по указанным данным. Завершается настройка выбором проекта, к которому относится узел, перечня контуров в которых будет работать узел (all для использования всех контуров) и описания узла.

## Изменение настроек узла в случае его переноса

**Особенности объекта управления, влияющие на проектные решения по функции**\
При копировании базы данных например из продуктивного контура в тестовый и при условии что ранее база в которую копируются данные была зарегистрирована в КШД, настройка подключения должна меняться автоматически на настройки базы, куда скопирована информация.

**Входящие данные**\
Строка подключения базы данных

**Исходящие данные**\
Отсутствуют

**Исполнитель**\
Регламентное задание

**Описание реализуемых задач**\
Выполняется проверка строки подключения и сохраненной строки подключения. Если строки различаются, выполняется механизм переключения, считываются настройки работы базы из узла master, изменяется место локального хранения для подключения master. Выполняется контроль к каким контурам подключена база, отключаются (удаляются) отсутствующие и добавляются папки для подключенных. Таким образом в месте указанном как локальное хранилище для узла всегда должны быть подключены (в разных папках) хранилища для каждого контура 

## Контроль и обновление репозиториев контуров узла

**Особенности объекта управления, влияющие на проектные решения по функции**\
Настройки контуров периодически меняются, в текущем узле всегда должна быть загружена актуальная информация по контуру.

**Входящие данные**\
Настройка подключения git "master"

**Исходящие данные**\
Отсутствуют

**Исполнитель**\
Регламентное задание

**Описание реализуемых задач**\
Выполняется контроль к каким контурам подключена база, отключаются (удаляются) отсутствующие и добавляются папки для подключенных. Таким образом в месте указанном как локальное хранилище для узла всегда должны быть подключены (в разных папках) хранилища для каждого контура.
