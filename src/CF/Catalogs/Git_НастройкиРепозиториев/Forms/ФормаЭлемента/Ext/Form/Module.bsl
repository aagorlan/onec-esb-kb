///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//	Библиотека работы с Git.                                                                                         //
//	Для работы требуется библиотека работы с безопасным хранилищем (общий модуль SDS_ОбщегоНазначения),              // 
//	либо использование БСП при условии замены в коде вызовов "SDS_ОбщегоНазначения" на "ОбщегоНазначения".           //
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	УстановитьОтображениеНастроекАвторизации();
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	СохранитьНастройкиАвторизации();
	Объект.ПутьЛокальногоХранения = СокрЛП(Объект.ПутьЛокальногоХранения);
	Если Прав(Объект.ПутьЛокальногоХранения, 1) = "\" Тогда
		Объект.ПутьЛокальногоХранения = Лев(Объект.ПутьЛокальногоХранения, СтрДлина(Объект.ПутьЛокальногоХранения));	
	КонецЕсли;
КонецПроцедуры         

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура СпособАвторизацииПриИзменении(Элемент)
	УстановитьОтображениеНастроекАвторизации();  
КонецПроцедуры

&НаКлиенте
Процедура СпособАвторизацииНачалоВыбора(Элемент, ДанныеВыбора, ВыборДобавлением, СтандартнаяОбработка)
	Если Не ЗначениеЗаполнено(Объект.Ссылка) Тогда
		СтандартнаяОбработка = Ложь;
		Оповещение = Новый ОписаниеОповещения("ПослеЗакрытияВопроса",
		      ЭтотОбъект);	
		 
	    ПоказатьВопрос(Оповещение,
	        "Продолжить?",
	        РежимДиалогаВопрос.ДаНет,
	        0, 
	        КодВозвратаДиалога.Да, 
	        "Для продолжения необходимо сохранить настройку");
	КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура УстановитьОтображениеНастроекАвторизации()
	Элементы.ГруппаАвторизацияOAuth.Видимость = 
										Объект.СпособАвторизации = ПредопределенноеЗначение("Перечисление.Git_СпособыАвторизации.OAuth");
	
	Элементы.ГруппаАвторизацияЛогинПароль.Видимость = 
										Объект.СпособАвторизации = ПредопределенноеЗначение("Перечисление.Git_СпособыАвторизации.ПоПаролю");																	
	ПроверитьНаличиеДанныхАвторизации();
КонецПроцедуры  

&НаКлиенте
Процедура ПроверитьНаличиеДанныхАвторизации()
	ДанныеАвторизации = ПолучитьДанныеАвторизации();
	Элементы.ГруппаУправлениеАвторизацией.Видимость = ЗначениеЗаполнено(ДанныеАвторизации);
	Элементы.ГруппаВариантыАвторизации.Видимость = Не Элементы.ГруппаУправлениеАвторизацией.Видимость;
КонецПроцедуры

&НаСервере
Функция ПолучитьДанныеАвторизации()	
	Если Объект.СпособАвторизации = ПредопределенноеЗначение("Перечисление.Git_СпособыАвторизации.OAuth") Тогда
		ДанныеАвторизации = Git_ПолныеПрава.ПрочитатьДанныеИзБезопасногоХранилища(Объект.Ссылка, "Токен");
	ИначеЕсли Объект.СпособАвторизации = ПредопределенноеЗначение("Перечисление.Git_СпособыАвторизации.ПоПаролю") Тогда
		ДанныеАвторизации = Git_ПолныеПрава.ПрочитатьДанныеИзБезопасногоХранилища(Объект.Ссылка, "Логин");
	Иначе
		ДанныеАвторизации = Неопределено;	
	КонецЕсли;
	Возврат ДанныеАвторизации;
КонецФункции

&НаСервере
Процедура СохранитьНастройкиАвторизации()
	Если Объект.СпособАвторизации = Перечисления.Git_СпособыАвторизации.ПоПаролю И ЗначениеЗаполнено(Логин) Тогда
		Git_ПолныеПрава.ЗаписатьДанныеВБезопасноеХранилище(Объект.Ссылка, СокрЛП(Логин), "Логин");
		Git_ПолныеПрава.ЗаписатьДанныеВБезопасноеХранилище(Объект.Ссылка, СокрЛП(Пароль));	
	ИначеЕсли Объект.СпособАвторизации = Перечисления.Git_СпособыАвторизации.OAuth И ЗначениеЗаполнено(Токен) Тогда
		Git_ПолныеПрава.ЗаписатьДанныеВБезопасноеХранилище(Объект.Ссылка, СокрЛП(Токен), "Токен");
	Иначе
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Проверьте заполнение данных авторизации";
		Сообщение.Сообщить();	
	КонецЕсли;
КонецПроцедуры
 
&НаКлиенте
Процедура ПослеЗакрытияВопроса(Результат, Параметры) Экспорт 
    Если Результат = КодВозвратаДиалога.Да Тогда
        Записать();
    КонецЕсли;	 
КонецПроцедуры

&НаСервере
Процедура ОчиститьДанныеАвторизацииНаСервере()
	Если Объект.СпособАвторизации = Перечисления.Git_СпособыАвторизации.ПоПаролю Тогда
		Git_ПолныеПрава.УдалитьДанныеИзБезопасногоХранилища(Объект.Ссылка, "Логин, Пароль");	
	ИначеЕсли Объект.СпособАвторизации = Перечисления.Git_СпособыАвторизации.OAuth Тогда
		Git_ПолныеПрава.УдалитьДанныеИзБезопасногоХранилища(Объект.Ссылка, "Токен");
	Иначе
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Выбран неизвестный тип авторизации";
		Сообщение.Сообщить();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ОчиститьДанныеАвторизации(Команда)
	ОчиститьДанныеАвторизацииНаСервере();
	ПроверитьНаличиеДанныхАвторизации();
КонецПроцедуры

&НаСервере
Процедура ПутьЛокальногоХраненияИзменениеТекстаРедактированияНаСервере()
	Элементы.Инициализирован.Доступность =
		Объект.Инициализирован И Объект.ПутьЛокальногоХранения <> Объект.Ссылка.ПутьЛокальногоХранения;
КонецПроцедуры

&НаКлиенте
Процедура ПутьЛокальногоХраненияИзменениеТекстаРедактирования(Элемент, Текст, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь; 
	Объект.ПутьЛокальногоХранения = Текст;
	КонецСтроки = СтрДлина(Текст) + 1;
	Элементы.ПутьЛокальногоХранения.УстановитьГраницыВыделения(КонецСтроки, КонецСтроки);
	ПутьЛокальногоХраненияИзменениеТекстаРедактированияНаСервере();
КонецПроцедуры

#КонецОбласти
